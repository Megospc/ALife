<!DOCTYPE html>
<html>
<head>
  <title>ALife - SandBox</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="headdiv">
    <h1 id="header" class="header"></h1>
    <a id="mainpage"></a>
  </div>
  <div id="select">
    <input type="file" id="fileinput" style="display: none" onchange="readFile(this.files[0])">
  </div>
  <div id="edit"></div>
  <div id="setup"></div>
  <div id="main"></div>
</body>
</html>
<script src="strings.js"></script>
<script src="utils.js"></script>
<script src="style.js"></script>
<script src="interface.js"></script>
<script src="main.js"></script>
<script src="render.js"></script>
<script>
  function readFile(file) {
    const reader = new FileReader();
    
    reader.readAsText(file);
    
    reader.onload = () => parseJSON(reader.result);
    reader.onerror = () => alert(strings.readFileFailed);
  }
  
  const { language, strings } = getWindowStrings(languagesStrings);
  
  const select = new Element("select");
  const edit = new Element("edit").hide();
  const main = new Element("main").hide();
  const setup = new Element("setup").hide();
  
  new Element("header").attr("textContent", strings.sandboxHeader);
  new Element("mainpage")
    .attr("textContent", strings.toMainpage)
    .attr("href", "index.html?lang="+language);
  
  new ButtonElement(strings.setupSelect, () => document.getElementById("fileinput").click()).to(select);
  
  new Element({
    elementType: "label",
    textContent: strings.sandboxName+":"
  }).to(edit);
  
  const nameelem = new Element({
    elementType: "input",
    type: "text",
    className: "nameinput",
    
    onchange: function() {
      obj.name = this.value;
    }
  }).to(new DivElement().to(edit));
  
  new Element({
    elementType: "label",
    textContent: strings.sandboxDescription+":"
  }).to(edit);
  
  const descrelem = new Element({
    elementType: "textarea",
    className: "textarea",
    
    onchange: function() {
      obj.description = this.value;
    }
  }).to(new DivElement().to(edit));
  
  new ButtonElement(strings.setupDownload, () => downloadText(getJSON(), obj.name+".alife-species")).to(new DivElement().to(edit));
  
  setupLanguageChanger(new DivElement().to(select), strings, language);
  
  var obj, simulation, interface, interval;
  
  const settings = setupSettings("setup", {
    strings,
    
    header: "h2",
    
    density: false,
    
    onstart: start
  });
  
  function getJSON() {
    obj.settings = {
      sun: settings.sun.value,
      resources: settings.resources.value
    };
    
    return JSON.stringify(obj);
  }
  
  function parseJSON(json) {
    try {
      obj = JSON.parse(json);
    } catch (e) {
      alert(strings.readFileFailed);
      
      return;
    }
    
    settings.randomSeed();
    
    nameelem.attr("value", obj.name);
    descrelem.attr("value", obj.description);
    
    settings.sun.value = obj.settings.sun ?? 500;
    settings.resources.value = obj.settings.resources ?? 10000;
    
    select.hide();
    edit.show();
    setup.show();
  }
  
  function start() {
    if (interval) {
      clearInterval(interval);
      
      main.attr("innerHTML", "");
    }
    
    const size = +settings.size.value;
    
    const reqmem = (size**2)*512;
    
    const gib = 2**30;
    
    const devmem = (navigator.deviceMemory ?? 0.5)*gib/2;
    
    if (devmem <= reqmem || reqmem >= gib) if (!confirm(strings.memoryAsk(reqmem))) return;
    
    simulation = createSimulation(size, size, {
      ...obj.consts,
      mutationChance: 0
    }, settings.seed.value);
    
    const methods = simulation.methods;
    
    const i = methods.posIndex(Math.floor(size/2), Math.floor(size/2));
    
    methods.putNewCellIndex(2, i);
    
    simulation.energy[i] = 20000;
    simulation.angle[i] = 0;
    
    simulation.current[i] = 0;
    simulation.curprog[i] = 0;
    simulation.clan[i] = 0;
    
    const genomeLength = simulation.consts.genomeWidth*simulation.consts.genomeHeight;
    
    for (let j = 0; j < genomeLength; j++) simulation.genome[i*genomeLength+j] = obj.genome[j];
  
    const charge = settings.resources.value;
    const organic = charge/simulation.consts.organicCost;
    
    for (let i = 0; i < simulation.organic.length; i++) simulation.organic[i] = organic;
    for (let i = 0; i < simulation.charge.length; i++) simulation.charge[i] = charge;
    
    simulation.sun = settings.sun.value;
    
    const targetsize = 
      size == 800 ? 1600:
      size == 1800 ? 1800:1200;
    
    interface = setupInterface("main", simulation, {
      strings,
      language,
      targetsize
    });
    
    interface.pause.onclick();
    
    renderer = createRenderer(interface, simulation, style);
  
    interval = startWindow([], [], interface, simulation, renderer);
    
    main.show();
  }
  
  if (sessionStorage.getItem("alife-save")) {
    parseJSON(sessionStorage.getItem("alife-save"));
    
    sessionStorage.setItem("alife-save", "");
  }
  /*
  const simulation = createSimulation(300, 300, {}, generateRandomSeed());
  
  const interface = setupInterface("main", simulation, {
    strings,
    targetsize: 1200
  });
  
  const renderer = createRenderer(interface, simulation, style);
  
  const methods = simulation.methods;
  
  for (let i = 0, clan = 0; i < simulation.type.length; i++) {
    if (!methods.chance(1/9)) continue;
    
    methods.putNewCellIndex(2, i);
    
    simulation.energy[i] = 20000;
    simulation.angle[i] = methods.randomInt(4);
    
    simulation.current[i] = 0;
    simulation.curprog[i] = 0;
    simulation.clan[i] = clan++;
    
    methods.copyGenome(i);
  }
  
  const charge = 10000;
  const organic = 50;
  
  for (let i = 0; i < simulation.organic.length; i++) simulation.organic[i] = organic;
  for (let i = 0; i < simulation.charge.length; i++) simulation.charge[i] = charge;
  
  simulation.sun = 500;
  
  setupLanguageChanger(new DivElement().to(main), strings, language);
  
  startWindow([], [], interface, simulation, renderer);
  
  function start() {
    
  }*/
</script>